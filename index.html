<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comprehensive Sensor Data Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .container {
      display: flex;
      justify-content: space-between;
    }
    .chart-container {
      width: 45%;
    }
    canvas {
      width: 100%;
      height: 300px;
    }
  </style>
</head>
<body>
  <h1>แดชบอร์ดข้อมูลเซ็นเซอร์ฟาร์ม</h1>
  <div class="container">
    <div class="chart-container">
      <h3>อุณหภูมิ</h3>
      <canvas id="tempChart"></canvas>
    </div>
    <div class="chart-container">
      <h3>ความชื้น</h3>
      <canvas id="humidityChart"></canvas>
    </div>
  </div>
  <div class="chart-container">
    <h3>ความชื้นในดิน</h3>
    <canvas id="soilMoistureChart"></canvas>
  </div>

  <script>
    // ดึงข้อมูลจากเซิร์ฟเวอร์
    async function fetchData() {
      try {
        const response = await fetch('http://localhost:3001/api/sensors');
        const data = await response.json();
        updateCharts(data);
      } catch (error) {
        console.error("เกิดข้อผิดพลาดในการดึงข้อมูลเซ็นเซอร์:", error);
      }
    }

    // อัปเดตกราฟด้วยข้อมูลใหม่
    function updateCharts(data) {
      const tempData = data.map(item => item.temperature);
      const humidityData = data.map(item => item.humidity);
      const soilMoistureData = data.map(item => item.soil_moisture);
      const timestamps = data.map(item => new Date(item.timestamp).toLocaleTimeString());

      // อัปเดตกราฟอุณหภูมิ
      tempChart.data.labels = timestamps;
      tempChart.data.datasets[0].data = tempData;
      tempChart.update();

      // อัปเดตกราฟความชื้น
      humidityChart.data.labels = timestamps;
      humidityChart.data.datasets[0].data = humidityData;
      humidityChart.update();

      // อัปเดตกราฟความชื้นในดิน
      soilMoistureChart.data.labels = timestamps;
      soilMoistureChart.data.datasets[0].data = soilMoistureData;
      soilMoistureChart.update();
    }

    // ตั้งค่ากราฟ
    const tempChart = new Chart(document.getElementById('tempChart'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'อุณหภูมิ (°C)',
          data: [],
          borderColor: 'rgb(255, 99, 132)',
          fill: false,
        }],
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'เวลา' } },
          y: { title: { display: true, text: 'อุณหภูมิ (°C)' } },
        },
      },
    });

    const humidityChart = new Chart(document.getElementById('humidityChart'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'ความชื้น (%)',
          data: [],
          borderColor: 'rgb(54, 162, 235)',
          fill: false,
        }],
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'เวลา' } },
          y: { title: { display: true, text: 'ความชื้น (%)' } },
        },
      },
    });

    const soilMoistureChart = new Chart(document.getElementById('soilMoistureChart'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'ความชื้นในดิน (%)',
          data: [],
          borderColor: 'rgb(75, 192, 192)',
          fill: false,
        }],
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'เวลา' } },
          y: { title: { display: true, text: 'ความชื้นในดิน (%)' } },
        },
      },
    });

    // ดึงข้อมูลเริ่มต้น
    fetchData();
    // ดึงข้อมูลใหม่ทุกๆ 5 วินาที
    setInterval(fetchData, 5000);
  </script>
</body>
</html>
